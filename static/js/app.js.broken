/* ============================================
   MindSpace - Main JavaScript
   ============================================ */

// ==================== GLOBAL STATE ================    
    if (messages.length === 0) {
        chatLog.innerHTML = `
                        const chatLog = document.getElementById('chat-log');
            if (chatLog) {
                chatLog.innerHTML = `
                    <div class="welcome-message">
                        <img src="/static/images/serene.png" alt="Serene" class="welcome-logo">
                        <h2 class="welcome-title">Welcome to Serene</h2>lass="welcome-message">
                <img src="/static/images/serene.png" alt="Serene" class="welcome-logo">
                <h2 class="welcome-title">Welcome to Serene</h2>
                <p class="welcome-subtitle">Your AI-powered mental health companion. Share your thoughts in a safe, supportive space.</p>
                <div class="quick-actions">
                    <button class="quick-btn" onclick="quickQuery('I\\'m feeling anxious')">üò∞ Feeling Anxious</button>
                    <button class="quick-btn" onclick="quickQuery('I need coping strategies')">üßò Coping Strategies</button>
                    <button class="quick-btn" onclick="quickQuery('How can I improve my mood?')">üòä Mood Help</button>
                </div>
            </div>`;
        return;
    }
    User = null;
let currentChatSessionId = null;
let chatSessions = [];

// ==================== THEME MANAGEMENT ====================
function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
}

function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
}

function updateThemeIcon(theme) {
    const icon = document.getElementById('theme-icon');
    if (icon) {
        icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }
}

// Initialize theme attribute immediately (before DOM loads for no flash)
const savedTheme = localStorage.getItem('theme') || 'light';
document.documentElement.setAttribute('data-theme', savedTheme);

// ==================== AUTH MANAGEMENT ====================
async function checkAuthStatus() {
    try {
        const response = await fetch('/api/auth/profile');
        if (response.ok) {
            const data = await response.json();
            currentUser = data.user;
            showAuthenticatedUI();
        } else {
            showGuestUI();
        }
    } catch (error) {
        console.error('Auth check failed:', error);
        showGuestUI();
    }
}

function showGuestUI() {
    const authGuest = document.getElementById('auth-guest');
    const authUser = document.getElementById('auth-user');
    
    if (authGuest) authGuest.style.display = 'flex';
    if (authUser) authUser.style.display = 'none';
}

function showAuthenticatedUI() {
    const authGuest = document.getElementById('auth-guest');
    const authUser = document.getElementById('auth-user');
    
    if (authGuest) authGuest.style.display = 'none';
    if (authUser) authUser.style.display = 'block';
    
    // Update user info displays
    const displayName = currentUser?.display_name || currentUser?.username || 'User';
    const email = currentUser?.email || '';
    
    const nameDisplay = document.getElementById('user-name-display');
    const dropdownName = document.getElementById('dropdown-name');
    const dropdownEmail = document.getElementById('dropdown-email');
    
    if (nameDisplay) nameDisplay.textContent = displayName;
    if (dropdownName) dropdownName.textContent = displayName;
    if (dropdownEmail) dropdownEmail.textContent = email;
}

async function logout() {
    try {
        await fetch('/api/auth/logout', { method: 'POST' });
        currentUser = null;
        showGuestUI();
        showToast('Logged out successfully', 'success');
    } catch (error) {
        showToast('Logout failed', 'error');
    }
}

// User Dropdown Toggle
function setupUserDropdown() {
    const profileBtn = document.getElementById('user-profile-btn');
    const dropdown = document.getElementById('user-dropdown');
    
    if (profileBtn && dropdown) {
        profileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            profileBtn.classList.toggle('active');
            dropdown.classList.toggle('visible');
        });
        
        document.addEventListener('click', () => {
            profileBtn?.classList.remove('active');
            dropdown?.classList.remove('visible');
        });
    }
}

// ==================== CHAT MANAGEMENT ====================
async function loadChatSessions() {
    try {
        const response = await fetch('/api/chats');
        if (response.ok) {
            const data = await response.json();
            chatSessions = data.sessions || [];
            renderChatList();
            
            if (chatSessions.length > 0) {
                await loadChatSession(chatSessions[0].id);
            }
        }
    } catch (error) {
        console.error('Failed to load chat sessions:', error);
    }
}

function renderChatList() {
    const chatList = document.getElementById('chat-list');
    if (!chatList) return;
    
    if (chatSessions.length === 0) {
        chatList.innerHTML = `
            <div class="chat-list-empty">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <p>No conversations yet</p>
                <p style="font-size: 11px; margin-top: 4px;">Start chatting to begin</p>
            </div>`;
        return;
    }
    
    chatList.innerHTML = chatSessions.map(session => `
        <div class="chat-item ${session.id === currentChatSessionId ? 'active' : ''}" 
             onclick="loadChatSession('${session.id}')">
            <div class="chat-item-content">
                <div class="chat-item-title">${escapeHtml(session.title || 'New Chat')}</div>
                <div class="chat-item-date">${formatRelativeTime(session.updated_at)}</div>
            </div>
            <button class="chat-item-delete" onclick="event.stopPropagation(); deleteChatSession('${session.id}')">
                üóëÔ∏è
            </button>
        </div>
    `).join('');
}

async function loadChatSession(sessionId) {
    try {
        currentChatSessionId = sessionId;
        renderChatList();
        
        // First load the session into memory on the backend
        await fetch(`/api/chats/${sessionId}/load`, { method: 'POST' });
        
        // Then get the session details and messages
        const response = await fetch(`/api/chats/${sessionId}`);
        if (response.ok) {
            const data = await response.json();
            const session = data.session || chatSessions.find(s => s.id === sessionId);
            
            updateChatTitle(session?.title || 'Chat');
            renderMessages(data.messages || []);
        }
    } catch (error) {
        console.error('Failed to load chat session:', error);
    }
}

function renderMessages(messages) {
    const chatLog = document.getElementById('chat-log');
    if (!chatLog) return;
    
    if (messages.length === 0) {
        chatLog.innerHTML = `
            <div class="welcome-message">
                <div class="welcome-icon">ÔøΩ</div>
                <h2 class="welcome-title">Welcome to Serene</h2>
                <p class="welcome-subtitle">Your AI-powered mental health companion. Share your thoughts in a safe, supportive space.</p>
                <div class="quick-actions">
                    <button class="quick-btn" onclick="quickQuery('I\\'m feeling anxious')">üò∞ Feeling Anxious</button>
                    <button class="quick-btn" onclick="quickQuery('I need coping strategies')">üßò Coping Strategies</button>
                    <button class="quick-btn" onclick="quickQuery('How can I improve my mood?')">üòä Mood Help</button>
                </div>
            </div>`;
        return;
    }
    
    // Handle both formats: {message, response} from DB and {role, content} from streaming
    let html = '';
    messages.forEach(msg => {
        if (msg.message !== undefined && msg.response !== undefined) {
            // Database format: {message, response}
            html += `
                <div class="chat-message user-message">
                    <div class="message-wrapper">
                        <div class="avatar user-avatar">üë§</div>
                        <div class="message-content">${escapeHtml(msg.message)}</div>
                    </div>
                </div>
                <div class="chat-message bot-message">
                    <div class="message-wrapper">
                        <div class="avatar bot-avatar">ÔøΩ</div>
                        <div class="message-content">${formatBotResponse(msg.response)}</div>
                    </div>
                </div>
            `;
        } else {
            // Streaming format: {role, content}
            const isUser = msg.role === 'user';
            html += `
                <div class="chat-message ${isUser ? 'user-message' : 'bot-message'}">
                    <div class="message-wrapper">
                        <div class="avatar ${isUser ? 'user-avatar' : 'bot-avatar'}">${isUser ? 'üë§' : 'ÔøΩ'}</div>
                        <div class="message-content">${isUser ? escapeHtml(msg.content) : formatBotResponse(msg.content)}</div>
                    </div>
                </div>
            `;
        }
    });
    
    chatLog.innerHTML = html;
    scrollToBottom();
}

async function createNewChat() {
    try {
        const response = await fetch('/api/chats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: 'New Chat' })
        });
        
        if (response.ok) {
            const data = await response.json();
            currentChatSessionId = data.id;
            await loadChatSessions();
            
            const chatLog = document.getElementById('chat-log');
            if (chatLog) {
                chatLog.innerHTML = `
                    <div class="welcome-message">
                        <div class="welcome-icon">ÔøΩ</div>
                        <h2 class="welcome-title">Welcome to Serene</h2>
                        <p class="welcome-subtitle">Your AI-powered mental health companion. Share your thoughts in a safe, supportive space.</p>
                        <div class="quick-actions">
                            <button class="quick-btn" onclick="quickQuery('I\\'m feeling anxious')">üò∞ Feeling Anxious</button>
                            <button class="quick-btn" onclick="quickQuery('I need coping strategies')">üßò Coping Strategies</button>
                            <button class="quick-btn" onclick="quickQuery('How can I improve my mood?')">üòä Mood Help</button>
                        </div>
                    </div>`;
            }
            updateChatTitle('New Chat');
        }
    } catch (error) {
        console.error('Failed to create chat:', error);
        showToast('Failed to create new chat', 'error');
    }
}

async function deleteChatSession(sessionId) {
    if (!confirm('Delete this conversation?')) return;
    
    try {
        const response = await fetch(`/api/chats/${sessionId}`, { method: 'DELETE' });
        if (response.ok) {
            await loadChatSessions();
            showToast('Chat deleted', 'success');
        }
    } catch (error) {
        showToast('Failed to delete chat', 'error');
    }
}

function updateChatTitle(title) {
    const titleEl = document.getElementById('current-chat-title');
    if (titleEl) titleEl.textContent = title;
}

function editChatTitle() {
    const newTitle = prompt('Enter new chat title:');
    if (newTitle && currentChatSessionId) {
        fetch(`/api/chats/${currentChatSessionId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: newTitle })
        }).then(() => {
            updateChatTitle(newTitle);
            loadChatSessions();
        });
    }
}

// ==================== MESSAGE SENDING ====================
function sendMessage() {
    const input = document.getElementById('user-input');
    const userQuery = input.value.trim();
    if (!userQuery) return;
    
    // Auto-create chat session if none exists
    if (!currentChatSessionId) {
        createNewChatAndSend(userQuery);
        return;
    }
    
    // Remove welcome message
    const welcome = document.querySelector('.welcome-message');
    if (welcome) welcome.remove();
    
    // Add user message to UI
    addMessageToUI(userQuery, true);
    
    // Clear input
    input.value = '';
    input.style.height = 'auto';
    
    // Send to API with streaming
    streamChatResponse(userQuery);
}

async function createNewChatAndSend(userQuery) {
    try {
        const response = await fetch('/api/chats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: userQuery.substring(0, 50) })
        });
        
        if (response.ok) {
            const data = await response.json();
            currentChatSessionId = data.id;
            await loadChatSessions();
            sendMessage();
        }
    } catch (error) {
        showToast('Failed to start chat', 'error');
    }
}

function addMessageToUI(content, isUser) {
    const chatLog = document.getElementById('chat-log');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${isUser ? 'user-message' : 'bot-message'}`;
    messageDiv.innerHTML = `
        <div class="message-wrapper">
            <div class="avatar ${isUser ? 'user-avatar' : 'bot-avatar'}">${isUser ? 'üë§' : 'ÔøΩ'}</div>
            <div class="message-content">${isUser ? escapeHtml(content) : formatBotResponse(content)}</div>
        </div>
    `;
    chatLog.appendChild(messageDiv);
    scrollToBottom();
    return messageDiv;
}

async function streamChatResponse(query) {
    const chatLog = document.getElementById('chat-log');
    const sendBtn = document.getElementById('send-button');
    
    // Create streaming message container
    const streamingId = 'streaming-' + Date.now();
    const messageDiv = document.createElement('div');
    messageDiv.id = streamingId;
    messageDiv.className = 'chat-message bot-message';
    messageDiv.innerHTML = `
        <div class="message-wrapper">
            <div class="avatar bot-avatar">ÔøΩ</div>
            <div class="message-content">
                <span class="streaming-text"></span>
                <span class="streaming-cursor">‚ñã</span>
            </div>
        </div>
    `;
    chatLog.appendChild(messageDiv);
    scrollToBottom();
    
    // Disable send button
    sendBtn.disabled = true;
    sendBtn.textContent = '...';
    
    let fullResponse = '';
    
    try {
        const response = await fetch('/api/chat/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                query: query,
                chat_session_id: currentChatSessionId
            })
        });
        
        if (!response.ok) throw new Error('Stream failed');
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        const streamingText = messageDiv.querySelector('.streaming-text');
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        
                        if (data.type === 'token') {
                            fullResponse += data.content;
                            streamingText.innerHTML = formatBotResponse(fullResponse);
                            scrollToBottom();
                        } else if (data.type === 'done') {
                            // Handle completion
                            if (data.crisis_detected) {
                                messageDiv.classList.add('crisis-alert');
                            }
                        }
                    } catch (e) {
                        // Skip malformed JSON
                    }
                }
            }
        }
        
        // Remove cursor
        const cursor = messageDiv.querySelector('.streaming-cursor');
        if (cursor) cursor.remove();
        
        // Auto-update title if first message
        autoUpdateChatTitle(query);
        
    } catch (error) {
        console.error('Streaming error:', error);
        // Fallback to regular API
        fallbackChatRequest(query, streamingId);
    }
    
    // Re-enable send button
    sendBtn.disabled = false;
    sendBtn.textContent = 'Send';
}

async function fallbackChatRequest(query, streamingId) {
    try {
        const response = await fetch('/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `query=${encodeURIComponent(query)}&chat_session_id=${currentChatSessionId}`
        });
        
        const data = await response.json();
        const messageDiv = document.getElementById(streamingId);
        
        if (messageDiv) {
            const content = messageDiv.querySelector('.message-content');
            content.innerHTML = formatBotResponse(data.response);
            
            if (data.crisis_detected) {
                messageDiv.classList.add('crisis-alert');
            }
        }
    } catch (error) {
        showToast('Failed to get response', 'error');
    }
}

async function autoUpdateChatTitle(firstMessage) {
    const currentTitle = document.getElementById('current-chat-title')?.textContent;
    
    if (currentTitle === 'New Chat' && currentChatSessionId) {
        const newTitle = firstMessage.substring(0, 40) + (firstMessage.length > 40 ? '...' : '');
        
        try {
            await fetch(`/api/chats/${currentChatSessionId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: newTitle })
            });
            
            updateChatTitle(newTitle);
            loadChatSessions();
        } catch (error) {
            console.error('Failed to update title:', error);
        }
    }
}

function quickQuery(query) {
    const input = document.getElementById('user-input');
    if (input) {
        input.value = query;
        sendMessage();
    }
}

// ==================== MODAL MANAGEMENT ====================
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('visible');
        document.body.style.overflow = 'hidden';
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('visible');
        document.body.style.overflow = '';
    }
}

// Close modal on overlay click
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay')) {
        e.target.style.display = 'none';
        e.target.classList.remove('visible');
        document.body.style.overflow = '';
    }
});

// ==================== UTILITY FUNCTIONS ====================
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatBotResponse(text) {
    if (!text) return '';
    text = text.replace(/\n/g, '<br>');
    text = text.replace(/(<br>){2,}/g, '</p><p>');
    return `<p>${text}</p>`;
}

function formatRelativeTime(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
}

function scrollToBottom() {
    const chatLog = document.getElementById('chat-log');
    if (chatLog) {
        chatLog.scrollTop = chatLog.scrollHeight;
    }
}

function showToast(message, type = 'info') {
    // Remove existing toasts
    document.querySelectorAll('.toast').forEach(t => t.remove());
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('visible'), 10);
    setTimeout(() => {
        toast.classList.remove('visible');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Auto-resize textarea
function setupTextareaAutoResize() {
    const textarea = document.getElementById('user-input');
    if (textarea) {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });
        
        // Send on Enter (without Shift)
        textarea.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }
}

// Emergency Panel
function setupEmergencyPanel() {
    const emergencyBtn = document.querySelector('.emergency-btn');
    const emergencyCard = document.querySelector('.emergency-card');
    
    if (emergencyBtn && emergencyCard) {
        emergencyBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            emergencyCard.classList.toggle('visible');
        });
        
        document.addEventListener('click', (e) => {
            if (!emergencyCard.contains(e.target) && !emergencyBtn.contains(e.target)) {
                emergencyCard.classList.remove('visible');
            }
        });
    }
}

// ==================== DASHBOARD FUNCTIONS ====================
async function openDashboard() {
    openModal('dashboard-modal');
    await loadDashboardData();
}

async function loadDashboardData() {
    // Placeholder - implement based on your API
    console.log('Loading dashboard data...');
}

// ==================== WELLNESS FUNCTIONS ====================
async function openWellnessModal() {
    openModal('wellness-modal');
    // Load wellness data
    await loadWellnessData();
}

async function loadWellnessData() {
    try {
        const [breathingRes, meditationRes, statsRes] = await Promise.all([
            fetch('/api/wellness/breathing'),
            fetch('/api/wellness/meditation'),
            fetch('/api/wellness/stats')
        ]);
        
        if (breathingRes.ok) {
            const data = await breathingRes.json();
            renderBreathingExercises(data.exercises || []);
        }
        
        if (meditationRes.ok) {
            const data = await meditationRes.json();
            renderMeditationSessions(data.sessions || []);
        }
        
        if (statsRes.ok) {
            const stats = await statsRes.json();
            updateWellnessStats(stats);
        }
    } catch (error) {
        console.error('Failed to load wellness data:', error);
    }
}

function updateWellnessStats(stats) {
    const streakEl = document.getElementById('wellness-streak');
    const minutesEl = document.getElementById('wellness-minutes');
    const sessionsEl = document.getElementById('wellness-sessions');
    
    if (streakEl) streakEl.textContent = stats.streak?.current || 0;
    if (minutesEl) minutesEl.textContent = stats.totals?.minutes || 0;
    if (sessionsEl) sessionsEl.textContent = stats.totals?.sessions || 0;
}

function renderBreathingExercises(exercises) {
    const grid = document.getElementById('breathing-exercises-grid');
    if (!grid) return;
    
    if (exercises.length === 0) {
        grid.innerHTML = '<p class="placeholder-text">No exercises available</p>';
        return;
    }
    
    grid.innerHTML = exercises.map(ex => `
        <div class="exercise-card" onclick="selectExercise('breathing', '${ex.id}')">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span style="font-size: 32px;">${ex.icon || 'üå¨Ô∏è'}</span>
                <div>
                    <h4 style="margin: 0;">${ex.name}</h4>
                    <span style="font-size: 12px; color: var(--text-muted);">${ex.difficulty || 'Beginner'}</span>
                </div>
            </div>
            <p style="font-size: 13px; color: var(--text-secondary);">${ex.description}</p>
        </div>
    `).join('');
}

function renderMeditationSessions(sessions) {
    const grid = document.getElementById('meditation-exercises-grid');
    if (!grid) return;
    
    if (sessions.length === 0) {
        grid.innerHTML = '<p class="placeholder-text">No sessions available</p>';
        return;
    }
    
    grid.innerHTML = sessions.map(s => `
        <div class="exercise-card" onclick="selectExercise('meditation', '${s.id}')">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span style="font-size: 32px;">${s.icon || 'üßò'}</span>
                <div>
                    <h4 style="margin: 0;">${s.name}</h4>
                    <span style="font-size: 12px; color: var(--text-muted);">${s.difficulty || 'Beginner'}</span>
                </div>
            </div>
            <p style="font-size: 13px; color: var(--text-secondary);">${s.description}</p>
        </div>
    `).join('');
}

function showWellnessTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.wellness-tab').forEach(tab => tab.classList.remove('active'));
    event?.target?.classList.add('active');
    
    // Show correct content
    const breathingTab = document.getElementById('breathing-tab');
    const meditationTab = document.getElementById('meditation-tab');
    
    if (breathingTab) breathingTab.style.display = tabName === 'breathing' ? 'block' : 'none';
    if (meditationTab) meditationTab.style.display = tabName === 'meditation' ? 'block' : 'none';
}

function selectExercise(type, exerciseId) {
    showToast(`Selected ${type} exercise: ${exerciseId}`, 'info');
    // Implement exercise selection logic
}

// ==================== SIDEBAR FUNCTIONS ====================
function toggleSidebar() {
    const sidebar = document.getElementById('chat-sidebar');
    if (sidebar) {
        sidebar.classList.toggle('hidden');
    }
}

// ==================== PROFILE FUNCTIONS ====================
function openProfile() {
    if (currentUser) {
        const displayNameInput = document.getElementById('profile-display-name');
        const emailInput = document.getElementById('profile-email');
        const usernameInput = document.getElementById('profile-username');
        
        if (displayNameInput) displayNameInput.value = currentUser.display_name || '';
        if (emailInput) emailInput.value = currentUser.email || '';
        if (usernameInput) usernameInput.value = currentUser.username || '';
    }
    openModal('profile-modal');
}

function openSettings() {
    openModal('settings-modal');
}

function saveSettings() {
    showToast('Settings saved', 'success');
    closeModal('settings-modal');
}

function changePassword() {
    showToast('Password change functionality', 'info');
}

function deleteAccount() {
    if (confirm('Are you sure you want to delete your account?')) {
        showToast('Account deletion functionality', 'info');
    }
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
    // Initialize theme icon
    const currentTheme = document.documentElement.getAttribute('data-theme');
    updateThemeIcon(currentTheme);
    
    // Check auth status
    checkAuthStatus();
    
    // Setup UI components
    setupUserDropdown();
    setupTextareaAutoResize();
    setupEmergencyPanel();
    
    // Load chat sessions
    loadChatSessions();
    
    // Setup send button
    const sendBtn = document.getElementById('send-button');
    if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
    }
    
    // Focus input
    const input = document.getElementById('user-input');
    if (input) input.focus();
});
