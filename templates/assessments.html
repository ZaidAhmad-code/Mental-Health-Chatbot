<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Assessments - Serene</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/images/serene.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #D8D3C8;
            --bg-secondary: #F5F4F1;
            --bg-tertiary: #E5E0D8;
            --accent-primary: #2D5A3D;
            --accent-secondary: #3E7A52;
            --accent-warm: #B8845A;
            --text-primary: #1A2820;
            --text-secondary: #3A4D42;
            --text-muted: #5A6E62;
            --border-color: rgba(45, 90, 61, 0.3);
            --success: #2D5A3D;
            --warning: #B8845A;
            --danger: #B85A4A;
            --shadow: 0 4px 24px rgba(26, 40, 32, 0.2);
        }

        [data-theme="dark"] {
            --bg-primary: #1A1F1C;
            --bg-secondary: #242B27;
            --bg-tertiary: #2E3632;
            --accent-primary: #6B9B7A;
            --accent-secondary: #8FB996;
            --text-primary: #E8E4DF;
            --text-secondary: #B0ADA8;
            --text-muted: #7A7873;
            --border-color: rgba(107, 155, 122, 0.2);
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .page-title h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .page-title p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .theme-toggle {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--accent-primary);
            color: white;
        }

        /* Assessment Selection */
        .assessment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .assessment-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .assessment-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .assessment-card.selected {
            border-color: var(--accent-primary);
            background: rgba(74, 124, 89, 0.05);
        }

        .assessment-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .assessment-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .assessment-info h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .assessment-info span {
            font-size: 12px;
            color: var(--text-muted);
        }

        .assessment-card p {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Quiz Section */
        .quiz-section {
            display: none;
        }

        .quiz-section.active {
            display: block;
        }

        .quiz-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 32px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-primary);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .question-counter {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .question-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .options-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-btn {
            width: 100%;
            padding: 16px 20px;
            text-align: left;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 12px;
            font-size: 15px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-btn:hover {
            border-color: var(--accent-primary);
            background: rgba(74, 124, 89, 0.05);
        }

        .option-btn.selected {
            border-color: var(--accent-primary);
            background: rgba(74, 124, 89, 0.1);
        }

        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 28px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .nav-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-btn.secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .nav-btn.secondary:hover {
            border-color: var(--accent-primary);
        }

        .nav-btn.primary {
            background: var(--accent-primary);
            border: none;
            color: white;
        }

        .nav-btn.primary:hover {
            background: var(--accent-secondary);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .results-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 32px;
            border: 1px solid var(--border-color);
            text-align: center;
            box-shadow: var(--shadow);
        }

        .score-display {
            margin-bottom: 24px;
        }

        .score-circle {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .score-number {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 48px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .score-label {
            font-size: 13px;
            color: var(--text-muted);
        }

        .severity-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .severity-minimal {
            background: rgba(74, 124, 89, 0.1);
            color: var(--success);
        }

        .severity-mild {
            background: rgba(212, 165, 116, 0.1);
            color: var(--warning);
        }

        .severity-moderate {
            background: rgba(212, 165, 116, 0.2);
            color: #B8956A;
        }

        .severity-severe {
            background: rgba(199, 107, 92, 0.1);
            color: var(--danger);
        }

        .results-description {
            margin: 24px 0;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            text-align: left;
        }

        .results-description h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .results-description p {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .results-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
        }

        .action-btn {
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .action-btn.primary {
            background: var(--accent-primary);
            border: none;
            color: white;
        }

        .action-btn.primary:hover {
            background: var(--accent-secondary);
        }

        .action-btn.secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .action-btn.secondary:hover {
            border-color: var(--accent-primary);
        }

        /* History Section */
        .history-section {
            margin-top: 40px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .history-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .history-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .history-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .history-item-text h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .history-item-text span {
            font-size: 12px;
            color: var(--text-muted);
        }

        .history-item-score {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        @media (max-width: 600px) {
            .assessment-grid {
                grid-template-columns: 1fr;
            }

            .quiz-card, .results-card {
                padding: 24px;
            }

            .results-actions {
                flex-direction: column;
            }

            .action-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="page-header">
            <div class="header-left">
                <a href="/" class="back-btn">‚Üê</a>
                <div class="page-title">
                    <h1>üìã Clinical Assessments</h1>
                    <p>Evidence-based mental health screening tools</p>
                </div>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="theme-icon">üåô</span>
            </button>
        </header>

        <!-- Assessment Selection -->
        <div id="selection-section">
            <div class="assessment-grid">
                <div class="assessment-card" onclick="selectAssessment('phq9')">
                    <div class="assessment-card-header">
                        <div class="assessment-icon">üß†</div>
                        <div class="assessment-info">
                            <h3>PHQ-9</h3>
                            <span>9 questions ‚Ä¢ 3 min</span>
                        </div>
                    </div>
                    <p>Patient Health Questionnaire for depression screening. Widely used to assess severity of depressive symptoms.</p>
                </div>

                <div class="assessment-card" onclick="selectAssessment('gad7')">
                    <div class="assessment-card-header">
                        <div class="assessment-icon">üí≠</div>
                        <div class="assessment-info">
                            <h3>GAD-7</h3>
                            <span>7 questions ‚Ä¢ 2 min</span>
                        </div>
                    </div>
                    <p>Generalized Anxiety Disorder scale. A brief measure for assessing anxiety severity.</p>
                </div>
            </div>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-section" class="quiz-section">
            <div class="quiz-card">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <div class="question-counter" id="question-counter">Question 1 of 9</div>
                <div class="question-text" id="question-text">Loading question...</div>
                <div class="options-list" id="options-list"></div>
                <div class="quiz-navigation">
                    <button class="nav-btn secondary" id="prev-btn" onclick="prevQuestion()" disabled>‚Üê Previous</button>
                    <button class="nav-btn primary" id="next-btn" onclick="nextQuestion()">Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="results-section">
            <div class="results-card">
                <div class="score-display">
                    <div class="score-circle">
                        <div class="score-number" id="result-score">0</div>
                        <div class="score-label" id="result-max">out of 27</div>
                    </div>
                </div>
                <div class="severity-badge" id="severity-badge">Calculating...</div>
                <div class="results-description" id="results-description">
                    <h4>What does this mean?</h4>
                    <p>Loading interpretation...</p>
                </div>
                <div class="results-actions">
                    <button class="action-btn secondary" onclick="resetAssessment()">Take Again</button>
                    <a href="/" class="action-btn primary">Return to Chat</a>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div class="history-section" id="history-section">
            <div class="history-header">
                <h2>Recent Assessments</h2>
            </div>
            <div class="history-list" id="history-list">
                <p style="color: var(--text-muted); text-align: center; padding: 20px;">No assessments yet</p>
            </div>
        </div>
    </div>

    <script>
        // Theme
        function initTheme() {
            const saved = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            document.getElementById('theme-icon').textContent = saved === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }
        
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            document.getElementById('theme-icon').textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }
        
        initTheme();

        // Assessment Data
        const assessments = {
            phq9: {
                name: 'PHQ-9',
                maxScore: 27,
                questions: [
                    "Little interest or pleasure in doing things",
                    "Feeling down, depressed, or hopeless",
                    "Trouble falling or staying asleep, or sleeping too much",
                    "Feeling tired or having little energy",
                    "Poor appetite or overeating",
                    "Feeling bad about yourself - or that you are a failure",
                    "Trouble concentrating on things",
                    "Moving or speaking slowly, or being fidgety/restless",
                    "Thoughts that you would be better off dead or hurting yourself"
                ],
                options: [
                    { text: "Not at all", value: 0 },
                    { text: "Several days", value: 1 },
                    { text: "More than half the days", value: 2 },
                    { text: "Nearly every day", value: 3 }
                ],
                getSeverity: (score) => {
                    if (score <= 4) return { level: 'Minimal', class: 'minimal', desc: 'Your responses suggest minimal symptoms of depression. Continue practicing self-care and healthy habits.' };
                    if (score <= 9) return { level: 'Mild', class: 'mild', desc: 'Your responses indicate mild symptoms. Consider incorporating relaxation techniques and reaching out to supportive friends or family.' };
                    if (score <= 14) return { level: 'Moderate', class: 'moderate', desc: 'Your responses suggest moderate symptoms. Speaking with a mental health professional could be beneficial.' };
                    if (score <= 19) return { level: 'Moderately Severe', class: 'severe', desc: 'Your responses indicate moderately severe symptoms. We recommend consulting with a healthcare provider.' };
                    return { level: 'Severe', class: 'severe', desc: 'Your responses suggest severe symptoms. Please reach out to a mental health professional as soon as possible.' };
                }
            },
            gad7: {
                name: 'GAD-7',
                maxScore: 21,
                questions: [
                    "Feeling nervous, anxious, or on edge",
                    "Not being able to stop or control worrying",
                    "Worrying too much about different things",
                    "Trouble relaxing",
                    "Being so restless that it's hard to sit still",
                    "Becoming easily annoyed or irritable",
                    "Feeling afraid as if something awful might happen"
                ],
                options: [
                    { text: "Not at all", value: 0 },
                    { text: "Several days", value: 1 },
                    { text: "More than half the days", value: 2 },
                    { text: "Nearly every day", value: 3 }
                ],
                getSeverity: (score) => {
                    if (score <= 4) return { level: 'Minimal', class: 'minimal', desc: 'Your responses suggest minimal anxiety. Continue practicing stress management techniques.' };
                    if (score <= 9) return { level: 'Mild', class: 'mild', desc: 'Your responses indicate mild anxiety. Consider breathing exercises and mindfulness practices.' };
                    if (score <= 14) return { level: 'Moderate', class: 'moderate', desc: 'Your responses suggest moderate anxiety. Speaking with a counselor could be helpful.' };
                    return { level: 'Severe', class: 'severe', desc: 'Your responses indicate severe anxiety. Please consider consulting with a mental health professional.' };
                }
            }
        };

        let currentAssessment = null;
        let currentQuestion = 0;
        let answers = [];

        function selectAssessment(type) {
            currentAssessment = assessments[type];
            currentQuestion = 0;
            answers = new Array(currentAssessment.questions.length).fill(null);
            
            document.getElementById('selection-section').style.display = 'none';
            document.getElementById('history-section').style.display = 'none';
            document.getElementById('quiz-section').classList.add('active');
            
            renderQuestion();
        }

        function renderQuestion() {
            const q = currentAssessment.questions[currentQuestion];
            const total = currentAssessment.questions.length;
            
            document.getElementById('progress-fill').style.width = ((currentQuestion + 1) / total * 100) + '%';
            document.getElementById('question-counter').textContent = `Question ${currentQuestion + 1} of ${total}`;
            document.getElementById('question-text').textContent = `Over the last 2 weeks, how often have you been bothered by: ${q}?`;
            
            const optionsHtml = currentAssessment.options.map((opt, i) => `
                <button class="option-btn ${answers[currentQuestion] === opt.value ? 'selected' : ''}" 
                        onclick="selectOption(${opt.value})">
                    ${opt.text}
                </button>
            `).join('');
            
            document.getElementById('options-list').innerHTML = optionsHtml;
            
            document.getElementById('prev-btn').disabled = currentQuestion === 0;
            document.getElementById('next-btn').textContent = currentQuestion === total - 1 ? 'Submit' : 'Next ‚Üí';
        }

        function selectOption(value) {
            answers[currentQuestion] = value;
            document.querySelectorAll('.option-btn').forEach((btn, i) => {
                btn.classList.toggle('selected', currentAssessment.options[i].value === value);
            });
        }

        function nextQuestion() {
            if (answers[currentQuestion] === null) {
                alert('Please select an answer');
                return;
            }
            
            if (currentQuestion < currentAssessment.questions.length - 1) {
                currentQuestion++;
                renderQuestion();
            } else {
                submitAssessment();
            }
        }

        function prevQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                renderQuestion();
            }
        }

        async function submitAssessment() {
            const score = answers.reduce((a, b) => a + b, 0);
            const severity = currentAssessment.getSeverity(score);
            
            // Show results
            document.getElementById('quiz-section').classList.remove('active');
            document.getElementById('results-section').classList.add('active');
            
            document.getElementById('result-score').textContent = score;
            document.getElementById('result-max').textContent = `out of ${currentAssessment.maxScore}`;
            
            const badge = document.getElementById('severity-badge');
            badge.textContent = severity.level;
            badge.className = `severity-badge severity-${severity.class}`;
            
            document.getElementById('results-description').innerHTML = `
                <h4>What does this mean?</h4>
                <p>${severity.desc}</p>
            `;
            
            // Save to server
            try {
                await fetch('/api/assessments/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        assessment_type: currentAssessment.name.toLowerCase(),
                        answers: answers,
                        score: score
                    })
                });
                loadHistory();
            } catch (e) {
                console.error('Failed to save assessment:', e);
            }
        }

        function resetAssessment() {
            document.getElementById('results-section').classList.remove('active');
            document.getElementById('selection-section').style.display = 'block';
            document.getElementById('history-section').style.display = 'block';
            currentAssessment = null;
        }

        async function loadHistory() {
            try {
                const res = await fetch('/api/assessments/history');
                if (res.ok) {
                    const data = await res.json();
                    renderHistory(data.assessments || []);
                }
            } catch (e) {
                console.error('Failed to load history:', e);
            }
        }

        function renderHistory(items) {
            const list = document.getElementById('history-list');
            if (!items.length) {
                list.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No assessments yet</p>';
                return;
            }
            
            list.innerHTML = items.slice(0, 5).map(item => `
                <div class="history-item">
                    <div class="history-item-info">
                        <div class="history-item-icon">${item.assessment_type === 'phq9' ? 'üß†' : 'üí≠'}</div>
                        <div class="history-item-text">
                            <h4>${item.assessment_type.toUpperCase()}</h4>
                            <span>${new Date(item.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="history-item-score">${item.total_score}</div>
                </div>
            `).join('');
        }

        // Load history on page load
        loadHistory();
    </script>
</body>
</html>
